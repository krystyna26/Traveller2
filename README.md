`cd prisma-traveller`

`npm init (use default values)`

`npm install`

`npm install babel-cli@6.26.0 babel-preset-env@1.7.0`

from root (=== prisma-traveller) create: '.babelrc' file with:

```
{
  "presets": [
    "env"
  ]
}
```

create file: /src/index.js
from prisma-traveller run: `npm run start`

from root: `npm i graphql-yoga@1.16.7` // 1.14.10

`npm install nodemon@1.17.5 --save-dev`

and change `"start": "babel-node src/index.js",` to "start": `"nodemon src/index.js --exec babel-node",`
(nodemon is not going to work in production - this is only for dev)

parent -
args - it is object; contains arguments values we supply
ex: query {
getUserByName(name: "Jess")
}
here args = {name: "Jess"}

context - contextual data, whatever we store in API
info - contains info about fields requested in playground

```
query {
  posts {
    id
    title
    author {
      name
    }
  }
}
```

in this query we are asking about author so for each post object resolver

```
Post: {
  author(parent is Post here,...)
}
```

will run to get author's name. So if we have 3 posts this function will run 3 times for each post

`npm install uuid@3.3.2`

`npm install babel-plugin-transform-object-rest-spread@6.26.0`

change: `"start": "nodemon src/index.js --exec babel-node",` to: `"start": "nodemon src/index.js --ext js, graphql --exec babel-node",`

if Query.users has 6 users then User.posts with run 6 times for each user object

---

## PRISMA

Lesson 43.

### HEROKU

Go to https://dashboard.heroku.com/apps New-> create new app -> choose name and region -> Create app
Overview -> search for heroku postgress and provision it. that will create a db.
Under 'settings' find credentials (d307m4np1mtd2).

### PGADMIN

Create new db on heroku and way to connect to it by GUI - pgAdmin, install Docker (to use Prisma) and run it.

### Install PRISMA

from root run: `npm install -g prisma@1.12.0`

from prisma-traveller: `prisma init prisma` and follow the steps:

> Set up a new Prisma server or deploy to an existing server? Use existing database <br />
> What kind of database do you want to deploy to? PostgreSQL<br />
> Does your database contain existing data? No<br />
> Enter database host ec2-54-83-33-14.compute-1.amazonaws.com<br />
> Enter database port 5432<br />
> Enter database user ecoro-user-zmgza<br />
> Enter database password b4edb77d8059e7e02244e2-password-59f7368dd4902dfaaf03579a46<br />
> Enter database name d4t0-database-hlor<br />
> Use SSL? Yes<br />
> Enter name of existing schema schema.graphql<br />

All this will create 3 files in 'prisma' folder:

datamodel.graphql - is a set of type definitions for gql similar to schema.graphql(this is a Node.js graphql API)

prisma.yml - holds configuration:
endpoint: http://localhost:4466/<default_service_name=project_name_forExample_test>/<default_stage_name>
If we deploy project with a different name this will not conflict with whatever we have already in pgAdmin. Lesson 56. http://localhost:4466 === http://localhost:4466/default/default
datamodel: datamodel.graphql

docker-compose.yml - will start the docker container
change there: `schema: schema.graphql` to `ssl:true` to be able to connect to heroku db

Deploy app and whats in 'prisma' folder:
cd prisma
`docker-compose up -d`
`prisma deploy` -> if we make changes in datamodel.graphql file

go to localhost:4466 - another instance for graphql playground but this time connected to graphql API provided by prisma itself (for example query will read data from that HEROKU db)

createUser and check if it was created in pgAdmin

---

from root: `npm install prisma-binding@2.1.1`
https://github.com/prisma/prisma-binding

in /src dir create new file prisma.js to keep there all code needed to connect Node.js with Prisma graphql API

typeDefs are autogenerated by Prisma (so their queries, mutations etc are not in datamodel.graphql) based on content from datamodel.graphql. We will store it in src/generated/prisma.graphql

```
import { Prisma } from 'prisma-binding';

const prisma = new Prisma({
  typeDefs: 'src/generated/prisma.graphql',
  endpoint: 'http://localhost:4466'
})
```

---

fetching schemas for given API and saving in file - run: `npm install graphql-cli@2.16.4`
https://github.com/graphql-cli/graphql-cli

from root create `.graphqlconfig` file. JSON file contains information where schema lives and where it should be saved

```
{
  "projects": {
    "prisma": {
      "schemaPath": "src/generated/prisma.graphql",
      "extensions": {
        "endpoints": {
          "default": "http://localhost:4466"
        }
      }
    }
  }
}
```

in package.json add object into scripts: "get-schema": "graphql get-schema -p prisma"

then run: `npm run get-schema`. This will connect to that endpoint, fetch the schema and store it in application file /prisma.graphql. Only time when we make changes in this file is when we re-run script and fetch the latest schema. So when I make changes to datamodel.graphql I need to run `prisma deploy` and script `npm run get-schema`.

### Setting up Node.js

from root: `npm start` and go to http://localhost:4000
Node.js is an intermediary between client and server

---

Adding SECRET:
to prisma.yml add secret property like `secret: my_secret_here` and the same to prisma.js but with quote `secret: 'my_secret_here'` and redeploy prisma

This will work only on localhost:4000. To make it work on localhost:4466 we must add Authorization object to localhost:4466 playground HTTP HEADERS like:

```
{
  "Authorization": "Bearer super_long_token_here"
}
```

## To get token for localhost:4466 : `cd prisma` and `prisma token`

Lesson 67.
in .graphqlconfig add single property on 'extensions' obj like: `"prisma": "prisma/prisma.yml",`. Otherwise you would not be able to get schema because we locked endpoint

## and then `npm run get-schema`

unistall uuidv4 -> npm uninstall uuid
`npm install bcryptjs@2.4.3`

`npm install jsonwebtoken@8.3.0`
this is the token that server is going to send to client when client sings up or logs in. And that is the same token later user will send with any request. Lesson 69.

const token = jwt.sign({ id: 45 }, "mybestguess")
const decode = jwt.decode(token)
const decoded2 = jwt.verify(token, 'mysecert')

---

---

## PAGINATION

Lesson:83

on localhost:4466 try queries with: first: Int and skip:Int
Add this params to schema.graphql Queries and in Query.js, then test it on localhost:4000

---

---

## DEPLOYMENT

lp-traveller-server

1. Production db (Prisma db hosted on Heroku - https://app.prisma.io/krystyna-2fc50b/servers/lp-traveller-server)
2. Host our Prisma docker container (Prisma server hosted on Heroku -> lp-traveller-server)
3. Host our Node.js application
   Services: Heroku | Prisma Cloud

Lesson:88
https://www.prisma.io/cloud login -> Servers -> Add server(and add it) -> Create new db -> and connect to Heroku -> Create data base -> Create new server -> Done

### Connecting to production db:

go to pgAdmin -> right click Create server -> put any name you want
on Prisma -> Servers -> Database click 'view on heroku' -> Heroku Postgres -> Settings -> View credentials -> C/P these credentials to open pgAdmin tab - Save and you should see db on the left side
db: dbgbsaj10fap45
If we have more project we can create more services, but we will always have one server.

### Setting dynamic endpoint in prisma.yml.

Lesson 89.

Create new folder: `config` with `dev.env` and `prod.env` files in it.
In `dev.env`:
`PRISMA_ENDPOINT=http://localhost:4466`
In `prisma.yml` override endpoint like: `"endpoint: ${env:PRISMA_ENDPOINT}"`

## From /prisma run: `prisma deploy -e ../config/dev.env` !!!

PRISMA_ENDPOINT=https://us1.prisma.sh/krystyna-2fc50b/lp-traveller-service/prod

### Deploying to server:

Login to prisma by runing `prisma login`, click Grand permission
`prisma deploy -e ../config/prod.env`
choose you app name and fill out some information:

> Set up a new Prisma server or deploy to an existing server? krystyna-2fc50b/lp-traveller <br />
> Choose a name for your service krystyna-lemeni-pop-traveller | lp-traveller-service <br />
> Choose a name for your stage prod <br />

Copy endpoint from `prisma.yml` and paste into prod.env like "PRISMA_ENDPOINT=https://lp-traveller-d24b2c0c04.herokuapp.com/krystyna-lemeni-pop-traveller/prod"
Now override prisma.yml endpoint like: "endpoint: \${env:PRISMA_ENDPOINT}" run `prisma deploy -e ../config/prod.env` and you're all set with deploying to prod.
go to PRISMA and under 'Services' tab you should see a new service
under playground tab you can go and perform all queries and mutations securely (with authorization injected). All of them match up with the one from localhost:4466.
https://klp-prisma-server-d03dab4c93.herokuapp.com/lp-traveller-service/prod/_admin - new playground

---

3. Lesson 91 - deploy Node app
   Go to https://git-scm.com/ and download git-scm.

If `git --version` doesn't show any errors, move on otherwise install it.

Run `npm install -g heroku`,

`heroku login` will allow CLI to manage our app so we can create apps and deploy new versions from Atom

Go to https://devcenter.heroku.com/articles/heroku-cli to read more.

Open /src/index.js and make changes:
Heroku is going to inject an env variable (that's why we have 'process.env.PORT' below)

```
server.start(({ port: process.env.PORT || 4000})=> {
  console.log("Server is up")
  // run: npm run start
  // check localhost:4000

  // heroku uses different port https://github.com/prisma/graphql-yoga Lesson 91
})
```

in prisma.js change endpoint LIKE: `"endpoint: process.env.PRISMA_ENDPOINT,"`

Install: `npm install env-cmd@8.0.2`
https://github.com/toddbluhm/env-cmd
In package.json change "start" and and "dev" like:

```
"start": "",
"dev":"env-cmd ./config/dev.env nodemon src/index.js --ext js, graphql --exec babel-node",
```

To run app locally, from root (prisma-traveller) run: `npm run dev` and check localhost:4000

### Heroku is going to use "start" to run application.

Lesson 92
https://devcenter.heroku.com/articles/nodejs-support#customizing-the-build-process
In package.json add custom script like:

```
"scripts": {
  "start": "",
  "heroku-postbuild": "babel src --out-dir dist --copy-files",
...
```

So this sctipt is going to run our code throught babel

Babel will read from src directory and spit those files out to dist directory. Dist contains everything what Node needs to run application.
Run: `npm run heroku-postbuild`
This will create new directory which contains everything what node.js needs to run app.

Now update start in package.json like:  
"scripts": {
"start": "env-cmd ./config/prod.env node dist/index.js",
...

We can't use babel in production. That requires to make small changes to.
Install: `npm install @babel/polyfill@7.0.0`
In src/index.js add import in first line like:
import '@babel/polyfill';

Delete /dist folder
And rebuild application: `npm run heroku-postbuild` and `npm run start`

Heroku is going to run script: "heroku-postbuild" and then "start"

From root run: `git init`
to .gitignore file add:
node_modules
config/
dist/
.DS_Store

`git add .`
`git commit -m "first commit"`

config folder is not being send to heroku because we just ignore it. So change package.json start script like: "start": "node dist/index.js",

`git add .`
`git commit -am "update start script for heroku"` 'a' is for adding changes files

Create an application:
Run: `heroku create`
Creating app... done, ⬢ shielded-earth-82413
https://shielded-earth-82413.herokuapp.com/ | https://git.heroku.com/shielded-earth-82413.git

Creating app... done, ⬢ pacific-tor-68155
https://pacific-tor-68155.herokuapp.com/ | https://git.heroku.com/pacific-tor-68155.git

ancient-falls-17194 - this is an app name
https://shielded-earth-82413.herokuapp.com/ - production instance of app; place where our code is visible
https://git.heroku.com/shielded-earth-82413.git - that is repository name ( check both by running: `git remote -v`)

To set environment on heroku:
Run: `heroku config:set PRISMA_ENDPOINT=https://lp-traveller-d24b2c0c04.herokuapp.com/krystyna-lemeni-pop-traveller/prod` endpoint copied from prod.env

To see all env variables set on heroku check: `heroku config`. These variables should match with ones in prod.env

To push all committed code up to heroku `git push heroku master`, the heroku is going to install modules, run code through babel and start up app.

Go to production version of app connecter to prod version of prisma: https://ancient-falls-17194.herokuapp.com/ :)

Deployment: PDF from Lesson 92!

Set secret in a separate files prod.env and dev.env and set it on heroku like: `heroku config:set PRISMA_SECRET=your_secret_here_copied_from_prod.env`

Deploying to development:
`cd prisma`
`prisma deploy -e ../config/dev.env` - to deploy new secret key

`cd ..`
`npm run dev`
On localhost:4000 check if any query works.

Deploying to heroku:

- commit new changes (extracting prisma secret to env variable)
- git push heroku master

Deploy prisma project to production:
`cd prisma`
`prisma deploy -e ../config/prod.env`

---

Section 9

create test.env file and paste dev.env content but change enpoint like: PRISMA_ENDPOINT=http://localhost:4466/default/test

from prisma run `prisma deploy -e ../config/test.env`

check changes on pgAdmin => refresh schema and you should see another default\$test

install as development dependencies: `npm install jest@23.5.0 --save-dev`

change test obj in package.json like: "test": "jest --watch" to watch tests

`npm run test` and build some tests :)

---

Lesson 98

https://parceljs.org/

cd to apollo-client
npm init
npm install parcel-bundler@1.9.7 --save-dev

change script in apollo package.json like: "start": "parcel src/index.html"

run: `npm run start` and go to localhost:1234 or any shown in terminal

---

### How to communicate with graphql from browser? Lesson 99

from apollo-client run: `npm run start` AND from prism-traveller: `npm run dev`

1. define an operation in JS
2. send that off to the server to fetch a response
3. access that response

`npm install apollo-boost@0.1.14 graphql@14.0.2`

create folder in /test and add two files: globalSetup.js and globalTeardown.js

Add new property into package.json like:
"jest": {
"globalSetup": "./tests/config/globalSetup.js",
"globalTeardown": "./tests/config/globalTeardown.js"
},

### Lesson 100

`npm install babel-register@6.26.0`

change test in package.json like: "test": "env-cmd ./config/test.env jest --watch",

start test: `npm run test`

Lesson 101
`npm install apollo-boost@0.1.14 graphql@14.0.2 cross-fetch@2.2.2`

When you run tests from user.test.js go check new created user in test schema in pgAdmin

### Lesson 105:

change package.json test property like:
"test": "env-cmd ./config/test.env jest --watch --runInBand",
restart `npm run test`

Lesson 108:
go to localhost:4000 and change creteUser mutation like:

mutation($first_name: String!) {
  createUser(
    data: {
      first_name: $first_name,
last_name: "Swider"
email: "hunter@example.com"
password: "zaq12wsx"
}
) {
user {
id
first_name
password
}
token
}
}

and add QUERY VARIABLE below like:

{
"first_name":"Hunter"
}

You can use there all types created in /prisma-traveller/src/schema.graphql

---

Lesson 111

To test subscriptions (because ApolloBoost doesn't support subscription):
npm install apollo-client@2.4.2 apollo-cache-inmemory@1.2.10 apollo-link-http@1.5.5 apollo-link-error@1.1.1 apollo-link@1.2.3 apollo-link-ws@1.0.9 apollo-utilities@1.0.21 subscriptions-transport-ws@0.9.15 @babel/polyfill@7.0.0 graphql@0.13.2

for more test ideas go to: links.mead.io/testideas

---

Lesson 114
To start another project we can copy 'prisma-traveller' folder
From there delete 'dist', "node_modules" folders and 'db.js' files. From 'prisma/datamodel' you should delete or modify all types based on new project needs.
From '/src' folder: whatever is relevant to datamodel file

tests/utils/operations -> whatever is relevant

`cd graphql-prisma-boilderplate`
Remove git repository: `rm -rf .git`
Create new repo: `git init`, `git add .`

Lesson 115 !!!!! Very usefull
Faster way to deploy

---

DEBUGGING:

`docker ps`
`docker logs <pid>`
`docker-compose down`

---

Problem with running `npm run get-schema`.
Cannot use GraphQLSchema "[object GraphQLSchema]" from another module or realm.
rm -rf node_modules/
npm install -g
npm run get-schema

---

ERROR: Couldn't connect to Docker daemon. You might need to start Docker for Mac.
Make sure you running docker

---

There is a relation ambiguity during the migration. Please first name the old relation on your schema. The ambiguity is on a relation between Trip and User. Please name relations or change the schema in steps."

## `prisma delete` to delete all existing data from db and then `prisma deploy`

FATAL: too many connections for role "asdf"
heroku pg:killall -a prisma-traveller

---

"message": "The change you are trying to make would violate the required relation 'CommentToTrip' between Comment and Trip",
Probably you have to re-deploy prisma

---

Two different lockfiles found: package-lock.json and
yarn.lock
https://stackoverflow.com/questions/47238241/heroku-build-failing-due-to-yarn-and-npm-lockfile-conflict

---

Warning from babel: @babel/polyfill is loaded more than once on this page. This is probably not desirable/intended and may have consequences if different versions of the polyfills are applied sequentially. If you do need to load the polyfill more than once, use @babel/polyfill/noC
onflict instead to bypass the warning.

## update import in sec.index.js like: import '@babel/polyfill/noConflict';

Server at default requires the Management API secret. Please set the the PRISMA_MANAGEMENT_API_SECRET environment variable.

https://www.prisma.io/docs/1.24/faq/how-to-reveal-management-api-secret-with-heroku-integration-fq03/

add it to prod.env and to heroku? and deploy again

## Don't instal beta!! (npm install -g prisma@beta)

## "Authentication token is invalid: Token can't be decoded: Invalid signature for this token or wrong algorithm.

"request to http://localhost:4466/food/dev failed, reason: socket hang up"

## error is comming from 'prisma deploy'. Make sure you deployed correctly

Error when running: heroku config:set PRISMA_ENDPOINT=https://us1.prisma.sh/krystyna-2fc50b/food/prod PRISMA_SECRET=thinkpositivesecret PR
ISMA_MANAGEMENT_API_SECRET=ce624c07c97ee6a

Error: Missing required flag:
› -a, --app APP app to run command against
› See more help with --help

Try to run: heroku config:set PRISMA_ENDPOINT=https://us1.prisma.sh/krystyna-2fc50b/food/prod PRISMA_SECRET=thinkpositivesecret PRISMA_MANAGEMENT_API_SECRET=ce624c07c97ee6a -a pure-everglades-49013

where "pure-everglades-49013" it's an app name

fatal: 'heroku' does not appear to be a git repository
fatal: Could not read from remote repository.

Please make sure you have the correct access rights
and the repository exists.
`heroku git:remote -a yourapp`

......

---

`docker ps` to get the process id
`docker kill <pid>` to kill the process
`docker rm <pid>` to remove it
`docker-compose up -d` to recreate it
Wait 20 seconds and open localhost:4466

(From there, try to redeploy Prisma
check the new container logs)

---

Krystyna:prisma-traveller krystynaswider\$ heroku ps
▸ Couldn't find that app.
Run:
`git remote rm heroku`
`git remote add heroku git@heroku.com:yourappname.git`
https://stackoverflow.com/questions/7615807/renamed-heroku-app-from-website-now-its-not-found

---

## run `git remote -v` That would show you the different Heroku apps that are connected with that project.

More about prisma: https://www.prisma.io/docs/datamodel-and-migrations/datamodel-MYSQL-knul/
update prisma: npm i -g prisma
correct DateTime: travel_started_at: "2019-10-10"

---

configure add-ons on heroku -> search for 'postgress' and add it

---

https://xd.adobe.com/view/b8261d75-dcfe-446c-4a1e-bb20f600d84c-ce17/screen/bba7cc4e-5990-482d-b6e7-334b03950d92/Web-1366-8

---

? Set up a new Prisma server or deploy to an existing server? krystyna-2fc50b/lp-traveller
? Choose a name for your service klp-traveller-prisma-service
? Choose a name for your stage prod

---

Can not deploy to a service stage while there is a deployment in progress… except there isn’t one...
https://v1.prisma.io/forum/t/can-not-deploy-to-a-service-stage-while-there-is-a-deployment-in-progress-except-there-isnt-one/6360

---

============== EXTRAS ===============

npm install @apollo/react-hooks

prisma.yml

# endpoint: https://lp-traveller-server-ae682aaac4.herokuapp.com/prisma-traveller/dev

# endpoint: https://us1.prisma.sh/krystyna-2fc50b/lp-traveller-service/prod

# endpoint: https://lp-traveller-d24b2c0c04.herokuapp.com/klp-traveller-prisma-service/prod

endpoint: https://lp-traveller-server-d760dd1aab.herokuapp.com/lp-traveller-service/dev
https://traveller-app-dev-server-lp.herokuapp.com/

"npm install react-apollo"

npx create-react-app react-traveller

npm install apollo-boost graphql react-apollo

---

https://pure-meadow-22429.herokuapp.com/ | https://git.heroku.com/pure-meadow-22429.git

---

PRISMA_CONFIG: |
port: 4466

# uncomment the next line and provide the env var PRISMA_MANAGEMENT_API_SECRET=my-secret to activate cluster security

# managementApiSecret: my-secret

databases:
default:
connector: postgres
host: ec2-18-235-20-228.compute-1.amazonaws.com
database: d2ck1f6hlr51o
schema: public
user: rupakiwdmwhasw
password: 328546f5365c65b6407f8de2d3b1223eb2cb1dcd0040ac37e4865b89a34a4ffd
ssl: true
rawAccess: true
port: '5432'
migrations: true

prisma
port: 4466

# uncomment the next line and provide the env var PRISMA_MANAGEMENT_API_SECRET=my-secret to activate cluster security

# managementApiSecret: my-secret

databases:
default:
connector: postgres
host: ec2-18-214-211-47.compute-1.amazonaws.com
database: de2ma7iqu5cc0b
schema: public
user: evpsuetwwbspip
password: d0521407b4d0f427985359dac71ba8ab4c3769c8324ed403174cf33998b824cc
ssl: true
rawAccess: true
port: '5432'
migrations: true
